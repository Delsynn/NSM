<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title></title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introductie.html">Introductie</a></li><li class="chapter-item expanded affix "><a href="box.html">Aanmaken monitor box</a></li><li class="chapter-item expanded affix "><a href="vagrantfile.html">Aanmaken van Vagrantfile</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introductie"><a class="header" href="#introductie">Introductie</a></h1>
<p>Wij hebben gekozen om een monitoring omgeving op te zetten, volledig via het gebruik van Vagrant boxes.</p>
<p>Deze omgeving omvat een monitor box die twee slave boxes monitored.</p>
<p>Iets waarmee wij nog niet geëxperimenteerd hadden was het volledig opzetten van onze eigen box, dus wij besloten dan ook hiermee aan de slag te gaan.</p>
<p>Onze keuze ging dus naar een Ubuntu Live server box die we zelf in elkaar hebben gestoken die we dan gebruiken om twee slaves nodes te monitoren waarvoor we een generieke Ubuntu box hebben gebruikt.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="creatie-van-de-monitoring-box"><a class="header" href="#creatie-van-de-monitoring-box">Creatie van de monitoring box</a></h1>
<p>Bij het creëren van een Vagrant box begint men bij het opzetten van een virtuele machine, hiervoor hadden wij gekozen voor het gebruik van de Ubuntu Server ISO die we hebben gedownload van de officiële <a href="https://ubuntu.com/download/server">site</a>.</p>
<p>De volgende stap was onderzoeken hoe het aanmaken van Vagrant box juist in zijn werking gaat, na wat opzoekwerk stuitten we op de volgende zeer behulpzame <a href="https://www.youtube.com/watch?v=Wqtlj9osK0g">video</a>.</p>
<p>In de video legde men uit, dat voor een succesvol werkende box aan te maken wij de volgende zaken moesten doen:</p>
<ol>
<li>
<h2 id="aanmaak-vm"><a class="header" href="#aanmaak-vm">Aanmaak VM</a></h2>
<p>We beginnen wij het aanmaken van een virtuele machine in Virtualbox, bij het doorlopen van de creatie wizard is het belangrijk de volgende zaken te doen:</p>
<ul>
<li>Het kiezen van een duidelijke naam, dit hebben wij nodig bij het omzetten van de VM naar een box.</li>
<li>Dan het selecteren van Ubuntu server ISO waar men deze heeft opgeslagen.</li>
<li>Zeker &quot;Skip Unattended Installation&quot; aanvinken want we zelf nog enkele opties kiezen bij de installatie.</li>
<li>Dan kunnen wij best voldoende geheugen kiezen aangezien wij meerdere applicaties op deze box zullen runnen maar in realiteit kan men dit geheugen nog zelf overschrijven in de Vagrantfile. Dit is echter wel handig tijdens het testen van de machine vooraleer wij deze omzetten naar een box.</li>
<li>Hetzelfde kan gezegd worden voor CPU, dus kunnen we evengoed voor 2 CPU's gaan tijdens het testen van de machine.</li>
<li>En als laatste kunnen we nog onze opslagcapaciteit kiezen, hier kan men best voor een goede hoeveelheid gaan.</li>
</ul>
</li>
<li>
<h2 id="installatie-vm"><a class="header" href="#installatie-vm">Installatie VM</a></h2>
<p>Tijdens de installatie zijn er enkele zaken die wij zelf moeten kiezen, voornamelijk kunnen wij met de standaard keuzes gaan maar er zijn er enkele die wij best zelf kiezen namelijk:</p>
<ul>
<li>Natuurlijk de taal, wij kozen voor English.</li>
<li>We werden gevraagd of wij de installer wensten te updaten, hievoor kozen wij ja.</li>
<li>Dan de toetsenbord layout, hier kozen wij voor Belgian om zo een Azerty-layout te krijgen.</li>
<li>Bij de type van installatie kozen wij voor de standaard Ubuntu Server.</li>
<li>Bij netwerk connecties hebben wij niets veranderd.</li>
<li>Niets ingevuld bij de proxy configuratie.</li>
<li>Ook de standaard archive mirror gelaten.</li>
<li>Niets veranderd bij de guided storage configuratie.</li>
<li>Ook niet bij de storage configuratie.</li>
<li>Dan komen we bij de profiel setup, hier kan men al een user aanmaken genaamd vagrant en voor paswoord ook vagrant kiezen. Men kan ook een naam en servernaam kiezen maar dat is minder belangrijk.</li>
<li>Niet nodig om naar Ubuntu Pro te upgraden, dus &quot;Skip for now&quot;.</li>
<li>We kunnen al de OpenSSH server installeren, dit kunnen wij best doen want hier maakt Vagrant gebruik van wanneer wij via het &quot;vagrant ssh&quot; commando met een de box proberen te connecteren.</li>
<li>Dan als laatste krijgen we bij de Ubuntu Live server de keuze uit enkele &quot;Featured Server Snaps&quot;. Dit zijn packages voor bepaalde veel gebruikte applicaties. Aangezien wij Prometheus als monitoring applicatie gingen gebruiken konden we deze al uit de lijst kiezen zodat de installatie hiervan al in orde was.</li>
</ul>
</li>
<li>
<h2 id="voorbereiding-conversie"><a class="header" href="#voorbereiding-conversie">Voorbereiding conversie</a></h2>
<p>Nu kunnen wij verder met het voorbereiden van de machine zodat deze kan geconverteerd worden naar een bruikbare, werkende box. Hiervoor konden we verder de video volgen:</p>
<ul>
<li>
<p>Voor de eerste settings moeten we overschakelen naar de root user met het commando &quot;sudo su -&quot; We zullen voor het paswoord gevraagd worden, dus vagrant.</p>
</li>
<li>
<p>Hij raad aan om de commando's hostnamectl&quot;, &quot;timedatectl&quot; en &quot;localectl uit te voeren om na te gaan of de instellingen qua hostnaam, tijd en locatie correct zijn. Deze kunnen nog veranderd worden indien nodig.</p>
</li>
<li>
<p>Vervolgens kijken we best na of het &quot;sudo&quot; package geïnstalleerd is door &quot;apt install sudo&quot; uit te voeren.</p>
</li>
<li>
<p>Dan moeten we een configuratie file aanmaken met gebruik van visudo, de video legt uit dat deze plugin file moet aangemaakt worden in de /etc/sudoers.d/ folder met de naam &quot;vagrant.tmp&quot; (/etc/sudoers.d/vagrant.tmp). Hij gebruikt hiervoor het commando:</p>
<pre><code>$ visudo -f /etc/sudoers.d/vagrant.tmp
</code></pre>
<p>Dit bestand bestaat nog niet maar door dit commando openen wij een nieuw bestand met de naam vagrant.tmp met de nano tekst editor. Wij moeten slechts 1 lijn tekst in dit bestand steken en het dan opslaan:</p>
<pre><code>vagrant ALL=(root) NOPASSWD: ALL
</code></pre>
</li>
<li>
<p>Vervolgens moeten we de vagrant user nog toevoegen aan de sudo groep, dit kunnen we doen met het volgende commando:</p>
<pre><code> $ usermod -aG sudo vagrant
</code></pre>
</li>
<li>
<p>Hierna moeten we terug naar de vagrant gebruiker overschakelen voor het downloaden van de publieke ssh sleutel voor deze gebruiker dit kunnen we doen met het commando &quot;su - vagrant&quot;</p>
</li>
<li>
<p>We zitten dan in de homefolder van de vagrant gebruiker (/home/vagrant) waar we dan de .ssh folder kunnen aanmaken en de publieke sleutel van de vagrant gebruiker kunnen downloaden met de volgende commando's:</p>
<pre><code>$ mkdir -m 700 .ssh
$ wget -O .ssh/authorized_keys https://raw.$ githubusercontent.com/hashicorp/vagrant/master/keys/vagrant.pub
$ cat .ssh/authorized_keys
$ chmod 600 .ssh/authorized_keys
</code></pre>
</li>
<li>
<p>We kunnen dan de historiek van de vagrant gebruiker commando's uitwissen met door het history -c commando uit te voeren en terug overschakelen naar de root user.</p>
</li>
<li>
<p>Nu moeten we over gaan op het installeren van de virtual box guest additions maar hiervoor moeten we eerst nog enkele packages installeren. We installeren de nodige packets met het commando:</p>
<pre><code>$ apt install -y dkms linux-headers-$(uname -r) build-essential
</code></pre>
<p>Wanneer de installatie van deze packages is afgelopen kunnen we de machine afsluiten met het &quot;poweroff&quot; commando.</p>
</li>
<li>
<p>Nu kunnen wij in virtualbox in de settings gaan van deze specifieke machine en bij storage onder de Controller: IDE bij Optical Drive op het cd logo klikken en dan uit het dropdown menu de VBoxGuessAdditions.iso kiezen.</p>
</li>
<li>
<p>Nu moeten we enkel nog de machine terug opstarten om de Guest additions te installeren.</p>
</li>
<li>
<p>Eenmaal opgestart switchen we weer over naar de root user met het commando &quot;sudo su -&quot;</p>
</li>
<li>
<p>We moeten dan de Optical Drive met de Guest additions iso mounten en installeren met de commando's:</p>
<pre><code>$ mount /dev/cdrom /mnt
$ /mnt/VBoxLinuxAdditions.run
</code></pre>
</li>
<li>
<p>Dit is alles wat nodig is om de basis template van de machine aan te maken en we kunnen nu overgaan tot het converteren van deze machine naar het vagrant box formaat.</p>
</li>
</ul>
</li>
<li>
<h2 id="applicaties"><a class="header" href="#applicaties">Applicaties</a></h2>
<p>Dit is echter niet het moment waarop wij deze machine in box formaat converteren, wij wilden eerst de nodige applicaties installeren op deze machine, in ons geval dus nog de Grafana applicatie zodat wij de gescrapete metrics kunnen visualiseren.</p>
<ul>
<li>
<p>Hiervoor starten wij de machine terug op en op de root user voeren we de volgende commando's uit:</p>
<pre><code>$ apt-get install -y adduser libfontconfig1 musl
$ wget https://dl.grafana.com/enterprise/release/grafana-enterprise_10.2.3_amd64.deb
$ dpkg -i grafana-enterprise_10.2.3_amd64.deb
</code></pre>
</li>
<li>
<p>Hierna kunnen we testen of Grafana correct is geïnstalleerd met de volgende commando's:</p>
<pre><code>$ systemctl start grafana-server
$ systemctl status grafana-server
</code></pre>
</li>
</ul>
<p>Dit is alles wat wij voor de monitoring box moeten voorbereiden aangezien Prometheus bij de installatie van de virtuele machine als is toegevoegd. Wij kunnen de Node Exporter module van Prometheus ook aan deze machine toevoegen zodat de machine zichzelf kan monitoren maar aangezien de installatie van Node Exporter op de slave machine via de Vagrantfile gebeurt (dit omdat we een al bestaande ubuntu box van vagrant cloud gebruiken) hebben we besloten om dit ook zo op de monitor machine te doen.</p>
</li>
<li>
<h2 id="conversie"><a class="header" href="#conversie">Conversie</a></h2>
<p>De video toont dan hoe we de virtuele machine kunnen converteren naar het vagrant box formaat met het commando:</p>
<pre><code>$ vagrant package --base monitor --output monitor.box
</code></pre>
<p>Mijn vm had de naam monitor dus dit gebruiken wij als de base en de geconverteerde box zal dus monitor.box noemen. Je kan hier eender welke naam kiezen maar het moet wel op .box eindigen. Je kan dit commando van eender waar uitvoeren normaal gezien maar je kan best voor alle zekerheid in de folder gaan waar de virtuele machine zich bevind.</p>
<p>Hierna heb je een vagrant box die je dan kan uploaden naar je eigen vagrant cloud. Na het inloggen op je account kan een nieuwe box toevoegen er een naam aangeven.</p>
<p>Hierna krijg je de mogelijkheid om een provider toe te voegen en kies je de volgende opties:</p>
<pre><code>Provider: Virtualbox
File hosting: Upload to Vagrant Cloud
Box Architecture: unknown
</code></pre>
<p>Je kan eventueel een hash maken van je vagrant box en dit toevoegen bij checksum maar dit is niet noodzakelijk.</p>
<p>En nu kan men deze box gebruiken in alle toekomstige Vagrantfile en kunnen wij overgaan tot het aanmaken van de Vagrantfile.</p>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="aanmaken-van-de-vagrantfile"><a class="header" href="#aanmaken-van-de-vagrantfile">Aanmaken van de Vagrantfile</a></h1>
<p>Nu wij de monitoring box hebben opgeladen op Vagrant Cloud kunnen wij deze gebruiken in de aanmaak van onze Vagrantfile.</p>
<p>Om de volledige opzet te laten werken zijn we na veel testen en aanpassen van de Vagrantfile (syntax of lijnen toevoegen) uitgekomen op de volgende &quot;code&quot;:</p>
<pre><code>    Vagrant.configure(&quot;2&quot;) do |config|
      # Master machine
      config.vm.define &quot;master&quot; do |master|
        master.vm.box = &quot;delsynn/ubuntuliveprometheus&quot;
        master.vm.box_version = &quot;1.1.0&quot;
        master.vm.network &quot;private_network&quot;, ip: &quot;192.168.50.4&quot;
        master.vm.network &quot;forwarded_port&quot;, guest: 3000, host: 3000
        master.vm.network &quot;forwarded_port&quot;, guest: 9090, host: 9090
        master.vm.network &quot;forwarded_port&quot;, guest: 9100, host: 9100
        master.vm.synced_folder &quot;./configs&quot;, &quot;/home/vagrant&quot;
        master.vm.provider &quot;virtualbox&quot; do |vb|
          vb.customize [&quot;modifyvm&quot;, :id, &quot;--cableconnected1&quot;, &quot;on&quot;]
          vb.customize [&quot;modifyvm&quot;, :id, &quot;--uart1&quot;, &quot;0x3F8&quot;, &quot;4&quot;]
          vb.customize [&quot;modifyvm&quot;, :id, &quot;--uartmode1&quot;, &quot;file&quot;, File::NULL]
          vb.gui = true
          vb.memory = &quot;2048&quot;
          vb.cpus = 2
        end
        master.vm.provision &quot;shell&quot;, inline: &lt;&lt;-SHELL
          echo &quot;Running shell commands on master...&quot;
          sudo snap start prometheus.prometheus
          sudo cp -f /home/vagrant/prometheus.yml /var/snap/prometheus/current
          sudo cp -f /home/vagrant/node_exporter.service /etc/systemd/system
          sudo snap restart prometheus
          sudo systemctl enable grafana-server
          sudo systemctl start grafana-server
          cd /tmp
          wget https://github.com/prometheus/node_exporter/releases/download/v1.7.0/node_exporter-1.7.0.linux-amd64.tar.gz
          tar xvfz node_exporter-1.7.0.linux-amd64.tar.gz
          sudo mv node_exporter-1.7.0.linux-amd64/node_exporter /usr/local/bin/
          sudo useradd -rs /bin/false node_exporter
          sudo systemctl daemon-reload
          sudo systemctl start node_exporter
          sudo systemctl enable node_exporter
        SHELL
      end

      # Slave machine 1
      config.vm.define &quot;slave1&quot; do |slave1|
        slave1.vm.box = &quot;bento/ubuntu-16.04&quot;
        slave1.vm.network &quot;private_network&quot;, ip: &quot;192.168.50.5&quot;
        slave1.vm.synced_folder &quot;./configs&quot;, &quot;/home/vagrant&quot;
        slave1.vm.provider &quot;virtualbox&quot; do |vb|
          vb.customize [&quot;modifyvm&quot;, :id, &quot;--cableconnected1&quot;, &quot;on&quot;]
          vb.customize [&quot;modifyvm&quot;, :id, &quot;--uart1&quot;, &quot;0x3F8&quot;, &quot;4&quot;]
          vb.customize [&quot;modifyvm&quot;, :id, &quot;--uartmode1&quot;, &quot;file&quot;, File::NULL]
          vb.gui = false
          vb.memory = &quot;2048&quot;
          vb.cpus = 2
        end
        slave1.vm.provision &quot;shell&quot;, inline: &lt;&lt;-SHELL
          echo &quot;Running shell commands on slave1...&quot;
          sudo apt-get update
          sudo cp -f /home/vagrant/node_exporter.service /etc/systemd/system
          cd /tmp
          sudo wget https://github.com/prometheus/node_exporter/releases/download/v1.7.0/node_exporter-1.7.0.linux-amd64.tar.gz
          sudo tar xvfz node_exporter-1.7.0.linux-amd64.tar.gz
          sudo mv node_exporter-1.7.0.linux-amd64/node_exporter /usr/local/bin/
          sudo useradd -rs /bin/false node_exporter
          sudo systemctl daemon-reload
          sudo systemctl start node_exporter
          sudo systemctl enable node_exporter
        SHELL
      end

      # Slave machine 2
      config.vm.define &quot;slave2&quot; do |slave2|
        slave2.vm.box = &quot;bento/ubuntu-16.04&quot;
        slave2.vm.network &quot;private_network&quot;, ip: &quot;192.168.50.6&quot;
        slave2.vm.synced_folder &quot;./configs&quot;, &quot;/home/vagrant&quot;
        slave2.vm.provider &quot;virtualbox&quot; do |vb|
          vb.customize [&quot;modifyvm&quot;, :id, &quot;--cableconnected1&quot;, &quot;on&quot;]
          vb.customize [&quot;modifyvm&quot;, :id, &quot;--uart1&quot;, &quot;0x3F8&quot;, &quot;4&quot;]
          vb.customize [&quot;modifyvm&quot;, :id, &quot;--uartmode1&quot;, &quot;file&quot;, File::NULL]
          vb.gui = false
          vb.memory = &quot;2048&quot;
          vb.cpus = 2
        end
        slave2.vm.provision &quot;shell&quot;, inline: &lt;&lt;-SHELL
          echo &quot;Running shell commands on slave2...&quot;
          sudo apt-get update
          sudo cp -f /home/vagrant/node_exporter.service /etc/systemd/system
          cd /tmp
          sudo wget https://github.com/prometheus/node_exporter/releases/download/v1.7.0/node_exporter-1.7.0.linux-amd64.tar.gz
          sudo tar xvfz node_exporter-1.7.0.linux-amd64.tar.gz
          sudo mv node_exporter-1.7.0.linux-amd64/node_exporter /usr/local/bin/
          sudo useradd -rs /bin/false node_exporter
          sudo systemctl daemon-reload
          sudo systemctl start node_exporter
          sudo systemctl enable node_exporter
        SHELL
      end
    end
</code></pre>
<p>Bij de monitoring machine (master) kan men zien dat wij onze zelfgemaakte box gaan downloaden:</p>
<pre><code>master.vm.box = &quot;delsynn/ubuntuliveprometheus&quot;
</code></pre>
<p>We maken een privé netwerk en zullen alle machines in hetzelfde subnet steken:</p>
<pre><code>master.vm.network &quot;private_network&quot;, ip: &quot;192.168.50.4&quot;
</code></pre>
<p>Wij gaan de ports van de verschillende applicaties forwarden zodat we deze via onze browser lokaal kunnen bereiken:</p>
<pre><code>master.vm.network &quot;forwarded_port&quot;, guest: 3000, host: 3000
master.vm.network &quot;forwarded_port&quot;, guest: 9090, host: 9090
master.vm.network &quot;forwarded_port&quot;, guest: 9100, host: 9100
</code></pre>
<p>En we syncen onze lokale configs folder met de /home/vagrant folder op de machine, dit omdat hier enkele configuratie files insteken voor prometheus en een .service file voor node exporter zodat we van Node Exporter een applicatie kunnen maken die in de achtergrond loopt:</p>
<pre><code>master.vm.synced_folder &quot;./configs&quot;, &quot;/home/vagrant&quot;
</code></pre>
<p>Deze bestanden zullen wij dan naar de correcte locaties kopiëren op de master machine.</p>
<p>Het gaat hier over de prometheus.yaml configuratie:</p>
<pre><code>global:
  scrape_interval:     15s # By default, scrape targets every 15 seconds.

  # Attach these labels to any time series or alerts when communicating with
  # external systems (federation, remote storage, Alertmanager).
  external_labels:
    monitor: 'monitor'

# A scrape configuration containing exactly one endpoint to scrape:
# Here it's Prometheus itself.
scrape_configs:
  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.
  - job_name: 'prometheus'

    # Override the global default and scrape targets from this job every 5 seconds.
    scrape_interval: 5s

    static_configs:
      - targets: ['localhost:9090']
  - job_name: 'node'
    scrape_interval: 5s
    static_configs:
      - targets: ['192.168.50.4:9100', '192.168.50.5:9100', '192.168.50.6:9100']
</code></pre>
<p>Hier kan men zien dat wij de ip's van de drie machines hebben toegevoegd als doelwitten voor het scrapen van de prometheus applicatie op de poort waarvan node exporter gebruik maakt (9100):</p>
<ul>
<li>192.168.50.4:9100</li>
<li>192.168.50.5:9100</li>
<li>192.168.50.6:9100</li>
</ul>
<p>En dan nog een .service file voor de Node Exporter applicatie, dit is nodig zodat Node Exporter in de achtergrond kan lopen:</p>
<pre><code>[Unit]
Description=Node Exporter
After=network.target
 
[Service]
User=node_exporter
Group=node_exporter
Type=simple
ExecStart=/usr/local/bin/node_exporter
 
[Install]
WantedBy=multi-user.target
</code></pre>
<p>Dit was nodig want we merkten dat tijdens het opstarten van de verschillende machines in de vagrantfile het proces kwam vast te zitten wanneer de Node Exporter applicatie opstart bij de eerste machine in de Vagrantfile (dus de master machine/monitor). Dit omdat deze applicatie out-of-the-box gewoon in de voorgrond wordt uitgevoerd.</p>
<p>Verder kennen we voldoende resources aan de machine toe:</p>
<pre><code>master.vm.provider &quot;virtualbox&quot; do |vb|
      vb.customize [&quot;modifyvm&quot;, :id, &quot;--cableconnected1&quot;, &quot;on&quot;]
      vb.customize [&quot;modifyvm&quot;, :id, &quot;--uart1&quot;, &quot;0x3F8&quot;, &quot;4&quot;]
      vb.customize [&quot;modifyvm&quot;, :id, &quot;--uartmode1&quot;, &quot;file&quot;, File::NULL]
      vb.gui = true
      vb.memory = &quot;2048&quot;
      vb.cpus = 2
</code></pre>
<p>En uiteindelijk gaan via de &quot;shell&quot; provisioner wat commando's uitvoeren op de machine:</p>
<pre><code>master.vm.provision &quot;shell&quot;, inline: &lt;&lt;-SHELL
      echo &quot;Running shell commands on master...&quot;
      sudo snap start prometheus.prometheus
      sudo cp -f /home/vagrant/prometheus.yml /var/snap/prometheus/current
      sudo cp -f /home/vagrant/node_exporter.service /etc/systemd/system
      sudo snap restart prometheus
      sudo systemctl enable grafana-server
      sudo systemctl start grafana-server
      cd /tmp
      wget https://github.com/prometheus/node_exporter/releases/download/v1.7.0/node_exporter-1.7.0.linux-amd64.tar.gz
      tar xvfz node_exporter-1.7.0.linux-amd64.tar.gz
      sudo mv node_exporter-1.7.0.linux-amd64/node_exporter /usr/local/bin/
      sudo useradd -rs /bin/false node_exporter
      sudo systemctl daemon-reload
      sudo systemctl start node_exporter
      sudo systemctl enable node_exporter
    SHELL
</code></pre>
<p>Zoals men kan zien doen wij de volgende zaken:</p>
<ul>
<li>We starten prometheus.</li>
<li>We kopiëren de configuratiefile van prometheus en de .service file van node exporter naar de correctie locaties.</li>
<li>We herstarten prometheus.</li>
<li>We zorgen dat grafana-server vanzelf opstart in de toekomst, dit hadden wij eigenlijk al kunnen doen bij het voorbereiden van de machine (aanmaken van een symbolische link).</li>
<li>En we starten grafana-server op.</li>
<li>Dan gaan wij in de /tmp folder om node exporter te downloaden, dit zodat deze file niet steeds wordt gedownload in de gesyncte folder.</li>
<li>We downloaden, extracten, en verplaatsten de node exporter applicatie naar de correcte folder (/usr/local/bin)</li>
<li>We herladen de systemd manager configuratie zodat de node_exporter.service file werkt.</li>
<li>En zorgen dat de node-exporter service ook opstart bij het rebooten van de machine.</li>
<li>We starten dan uiteindelijk de node-exporter service op.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
