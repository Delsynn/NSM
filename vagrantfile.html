<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Aanmaken van Vagrantfile</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introductie.html">Introductie</a></li><li class="chapter-item expanded affix "><a href="box.html">Aanmaken monitor box</a></li><li class="chapter-item expanded affix "><a href="vagrantfile.html" class="active">Aanmaken van Vagrantfile</a></li><li class="chapter-item expanded affix "><a href="totslot.html">Tot slot</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="aanmaken-van-de-vagrantfile"><a class="header" href="#aanmaken-van-de-vagrantfile">Aanmaken van de Vagrantfile</a></h1>
<p>Nu wij de monitoring box hebben opgeladen op Vagrant Cloud kunnen wij deze gebruiken in de aanmaak van onze Vagrantfile.</p>
<p>Om de volledige opzet te laten werken zijn we na veel testen en aanpassen van de Vagrantfile (syntax of lijnen toevoegen) uitgekomen op de volgende &quot;code&quot;:</p>
<pre><code>    Vagrant.configure(&quot;2&quot;) do |config|
      # Master machine
      config.vm.define &quot;master&quot; do |master|
        master.vm.box = &quot;delsynn/ubuntuliveprometheus&quot;
        master.vm.box_version = &quot;1.1.0&quot;
        master.vm.network &quot;private_network&quot;, ip: &quot;192.168.50.4&quot;
        master.vm.network &quot;forwarded_port&quot;, guest: 3000, host: 3000
        master.vm.network &quot;forwarded_port&quot;, guest: 9090, host: 9090
        master.vm.network &quot;forwarded_port&quot;, guest: 9100, host: 9100
        master.vm.synced_folder &quot;./configs&quot;, &quot;/home/vagrant&quot;
        master.vm.provider &quot;virtualbox&quot; do |vb|
          vb.customize [&quot;modifyvm&quot;, :id, &quot;--cableconnected1&quot;, &quot;on&quot;]
          vb.customize [&quot;modifyvm&quot;, :id, &quot;--uart1&quot;, &quot;0x3F8&quot;, &quot;4&quot;]
          vb.customize [&quot;modifyvm&quot;, :id, &quot;--uartmode1&quot;, &quot;file&quot;, File::NULL]
          vb.gui = true
          vb.memory = &quot;2048&quot;
          vb.cpus = 2
        end
        master.vm.provision &quot;shell&quot;, inline: &lt;&lt;-SHELL
          echo &quot;Running shell commands on master...&quot;
          sudo snap start prometheus.prometheus
          sudo cp -f /home/vagrant/prometheus.yml /var/snap/prometheus/current
          sudo cp -f /home/vagrant/node_exporter.service /etc/systemd/system
          sudo snap restart prometheus
          sudo systemctl enable grafana-server
          sudo systemctl start grafana-server
          cd /tmp
          wget https://github.com/prometheus/node_exporter/releases/download/v1.7.0/node_exporter-1.7.0.linux-amd64.tar.gz
          tar xvfz node_exporter-1.7.0.linux-amd64.tar.gz
          sudo mv node_exporter-1.7.0.linux-amd64/node_exporter /usr/local/bin/
          sudo useradd -rs /bin/false node_exporter
          sudo systemctl daemon-reload
          sudo systemctl start node_exporter
          sudo systemctl enable node_exporter
        SHELL
      end

      # Slave machine 1
      config.vm.define &quot;slave1&quot; do |slave1|
        slave1.vm.box = &quot;bento/ubuntu-16.04&quot;
        slave1.vm.network &quot;private_network&quot;, ip: &quot;192.168.50.5&quot;
        slave1.vm.synced_folder &quot;./configs&quot;, &quot;/home/vagrant&quot;
        slave1.vm.provider &quot;virtualbox&quot; do |vb|
          vb.customize [&quot;modifyvm&quot;, :id, &quot;--cableconnected1&quot;, &quot;on&quot;]
          vb.customize [&quot;modifyvm&quot;, :id, &quot;--uart1&quot;, &quot;0x3F8&quot;, &quot;4&quot;]
          vb.customize [&quot;modifyvm&quot;, :id, &quot;--uartmode1&quot;, &quot;file&quot;, File::NULL]
          vb.gui = false
          vb.memory = &quot;2048&quot;
          vb.cpus = 2
        end
        slave1.vm.provision &quot;shell&quot;, inline: &lt;&lt;-SHELL
          echo &quot;Running shell commands on slave1...&quot;
          sudo apt-get update
          sudo cp -f /home/vagrant/node_exporter.service /etc/systemd/system
          cd /tmp
          sudo wget https://github.com/prometheus/node_exporter/releases/download/v1.7.0/node_exporter-1.7.0.linux-amd64.tar.gz
          sudo tar xvfz node_exporter-1.7.0.linux-amd64.tar.gz
          sudo mv node_exporter-1.7.0.linux-amd64/node_exporter /usr/local/bin/
          sudo useradd -rs /bin/false node_exporter
          sudo systemctl daemon-reload
          sudo systemctl start node_exporter
          sudo systemctl enable node_exporter
        SHELL
      end

      # Slave machine 2
      config.vm.define &quot;slave2&quot; do |slave2|
        slave2.vm.box = &quot;bento/ubuntu-16.04&quot;
        slave2.vm.network &quot;private_network&quot;, ip: &quot;192.168.50.6&quot;
        slave2.vm.synced_folder &quot;./configs&quot;, &quot;/home/vagrant&quot;
        slave2.vm.provider &quot;virtualbox&quot; do |vb|
          vb.customize [&quot;modifyvm&quot;, :id, &quot;--cableconnected1&quot;, &quot;on&quot;]
          vb.customize [&quot;modifyvm&quot;, :id, &quot;--uart1&quot;, &quot;0x3F8&quot;, &quot;4&quot;]
          vb.customize [&quot;modifyvm&quot;, :id, &quot;--uartmode1&quot;, &quot;file&quot;, File::NULL]
          vb.gui = false
          vb.memory = &quot;2048&quot;
          vb.cpus = 2
        end
        slave2.vm.provision &quot;shell&quot;, inline: &lt;&lt;-SHELL
          echo &quot;Running shell commands on slave2...&quot;
          sudo apt-get update
          sudo cp -f /home/vagrant/node_exporter.service /etc/systemd/system
          cd /tmp
          sudo wget https://github.com/prometheus/node_exporter/releases/download/v1.7.0/node_exporter-1.7.0.linux-amd64.tar.gz
          sudo tar xvfz node_exporter-1.7.0.linux-amd64.tar.gz
          sudo mv node_exporter-1.7.0.linux-amd64/node_exporter /usr/local/bin/
          sudo useradd -rs /bin/false node_exporter
          sudo systemctl daemon-reload
          sudo systemctl start node_exporter
          sudo systemctl enable node_exporter
        SHELL
      end
    end
</code></pre>
<h2 id="master-box"><a class="header" href="#master-box">Master Box</a></h2>
<p>Bij de monitoring machine (master) kan men zien dat wij onze zelfgemaakte box gaan downloaden:</p>
<pre><code>master.vm.box = &quot;delsynn/ubuntuliveprometheus&quot;
</code></pre>
<p>We maken een privé netwerk en zullen alle machines in hetzelfde subnet steken:</p>
<pre><code>master.vm.network &quot;private_network&quot;, ip: &quot;192.168.50.4&quot;
</code></pre>
<p>Wij gaan de ports van de verschillende applicaties forwarden zodat we deze via onze browser lokaal kunnen bereiken:</p>
<pre><code>master.vm.network &quot;forwarded_port&quot;, guest: 3000, host: 3000
master.vm.network &quot;forwarded_port&quot;, guest: 9090, host: 9090
master.vm.network &quot;forwarded_port&quot;, guest: 9100, host: 9100
</code></pre>
<p>En we syncen onze lokale configs folder met de /home/vagrant folder op de machine, dit omdat hier enkele configuratie files insteken voor prometheus en een .service file voor node exporter zodat we van Node Exporter een applicatie kunnen maken die in de achtergrond loopt:</p>
<pre><code>master.vm.synced_folder &quot;./configs&quot;, &quot;/home/vagrant&quot;
</code></pre>
<p>Deze bestanden zullen wij dan naar de correcte locaties kopiëren op de master machine.</p>
<p>Het gaat hier over de prometheus.yaml configuratie:</p>
<pre><code>global:
  scrape_interval:     15s # By default, scrape targets every 15 seconds.

  # Attach these labels to any time series or alerts when communicating with
  # external systems (federation, remote storage, Alertmanager).
  external_labels:
    monitor: 'monitor'

# A scrape configuration containing exactly one endpoint to scrape:
# Here it's Prometheus itself.
scrape_configs:
  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.
  - job_name: 'prometheus'

    # Override the global default and scrape targets from this job every 5 seconds.
    scrape_interval: 5s

    static_configs:
      - targets: ['localhost:9090']
  - job_name: 'node'
    scrape_interval: 5s
    static_configs:
      - targets: ['192.168.50.4:9100', '192.168.50.5:9100', '192.168.50.6:9100']
</code></pre>
<p>Hier kan men zien dat wij de ip's van de drie machines hebben toegevoegd als doelwitten voor het scrapen van de prometheus applicatie op de poort waarvan node exporter gebruik maakt (9100):</p>
<ul>
<li>192.168.50.4:9100</li>
<li>192.168.50.5:9100</li>
<li>192.168.50.6:9100</li>
</ul>
<p>En dan nog een .service file voor de Node Exporter applicatie, dit is nodig zodat Node Exporter in de achtergrond kan lopen:</p>
<pre><code>[Unit]
Description=Node Exporter
After=network.target
 
[Service]
User=node_exporter
Group=node_exporter
Type=simple
ExecStart=/usr/local/bin/node_exporter
 
[Install]
WantedBy=multi-user.target
</code></pre>
<p>Dit was nodig want we merkten dat tijdens het opstarten van de verschillende machines in de vagrantfile het proces kwam vast te zitten wanneer de Node Exporter applicatie opstart bij de eerste machine in de Vagrantfile (dus de master machine/monitor). Dit omdat deze applicatie out-of-the-box gewoon in de voorgrond wordt uitgevoerd.</p>
<p>Verder kennen we voldoende resources aan de machine toe:</p>
<pre><code>master.vm.provider &quot;virtualbox&quot; do |vb|
      vb.customize [&quot;modifyvm&quot;, :id, &quot;--cableconnected1&quot;, &quot;on&quot;]
      vb.customize [&quot;modifyvm&quot;, :id, &quot;--uart1&quot;, &quot;0x3F8&quot;, &quot;4&quot;]
      vb.customize [&quot;modifyvm&quot;, :id, &quot;--uartmode1&quot;, &quot;file&quot;, File::NULL]
      vb.gui = true
      vb.memory = &quot;2048&quot;
      vb.cpus = 2
</code></pre>
<p>En uiteindelijk gaan via de &quot;shell&quot; provisioner wat commando's uitvoeren op de machine:</p>
<pre><code>master.vm.provision &quot;shell&quot;, inline: &lt;&lt;-SHELL
      echo &quot;Running shell commands on master...&quot;
      sudo snap start prometheus.prometheus
      sudo cp -f /home/vagrant/prometheus.yml /var/snap/prometheus/current
      sudo cp -f /home/vagrant/node_exporter.service /etc/systemd/system
      sudo snap restart prometheus
      sudo systemctl enable grafana-server
      sudo systemctl start grafana-server
      cd /tmp
      wget https://github.com/prometheus/node_exporter/releases/download/v1.7.0/node_exporter-1.7.0.linux-amd64.tar.gz
      tar xvfz node_exporter-1.7.0.linux-amd64.tar.gz
      sudo mv node_exporter-1.7.0.linux-amd64/node_exporter /usr/local/bin/
      sudo useradd -rs /bin/false node_exporter
      sudo systemctl daemon-reload
      sudo systemctl start node_exporter
      sudo systemctl enable node_exporter
    SHELL
</code></pre>
<p>Zoals men kan zien doen wij de volgende zaken:</p>
<ul>
<li>We starten prometheus.</li>
<li>We kopiëren de configuratiefile van prometheus en de .service file van node exporter naar de correctie locaties.</li>
<li>We herstarten prometheus.</li>
<li>We zorgen dat grafana-server vanzelf opstart in de toekomst, dit hadden wij eigenlijk al kunnen doen bij het voorbereiden van de machine (aanmaken van een symbolische link).</li>
<li>En we starten grafana-server op.</li>
<li>Dan gaan wij in de /tmp folder om node exporter te downloaden, dit zodat deze file niet steeds wordt gedownload in de gesyncte folder.</li>
<li>We downloaden, extracten, en verplaatsten de node exporter applicatie naar de correcte folder (/usr/local/bin)</li>
<li>Een system user wordt aangemaakt voor de uitvoeren van de node_exporter service.</li>
<li>We herladen de systemd manager configuratie zodat de node_exporter.service file werkt.</li>
<li>En zorgen dat de node-exporter service ook opstart bij het rebooten van de machine.</li>
<li>We starten dan uiteindelijk de node-exporter service op.</li>
</ul>
<h2 id="slave-boxes"><a class="header" href="#slave-boxes">Slave boxes</a></h2>
<p>De enige verschillen bij de slave boxes is dat we gebruik maken van een generieke ubuntu box die wij op Vagrant Cloud hebben gevonden. Een ip in hetzelfde subnet as de master box eraan toekennen en dezelfde commando's uitvoeren als op de master box om de node_exporter service op deze machines op te starten.</p>
<pre><code>      # Slave machine 1
      config.vm.define &quot;slave1&quot; do |slave1|
        slave1.vm.box = &quot;bento/ubuntu-16.04&quot;
        slave1.vm.network &quot;private_network&quot;, ip: &quot;192.168.50.5&quot;
        slave1.vm.synced_folder &quot;./configs&quot;, &quot;/home/vagrant&quot;
        slave1.vm.provider &quot;virtualbox&quot; do |vb|
          vb.customize [&quot;modifyvm&quot;, :id, &quot;--cableconnected1&quot;, &quot;on&quot;]
          vb.customize [&quot;modifyvm&quot;, :id, &quot;--uart1&quot;, &quot;0x3F8&quot;, &quot;4&quot;]
          vb.customize [&quot;modifyvm&quot;, :id, &quot;--uartmode1&quot;, &quot;file&quot;, File::NULL]
          vb.gui = false
          vb.memory = &quot;2048&quot;
          vb.cpus = 2
        end
        slave1.vm.provision &quot;shell&quot;, inline: &lt;&lt;-SHELL
          echo &quot;Running shell commands on slave1...&quot;
          sudo apt-get update
          sudo cp -f /home/vagrant/node_exporter.service /etc/systemd/system
          cd /tmp
          sudo wget https://github.com/prometheus/node_exporter/releases/download/v1.7.0/node_exporter-1.7.0.linux-amd64.tar.gz
          sudo tar xvfz node_exporter-1.7.0.linux-amd64.tar.gz
          sudo mv node_exporter-1.7.0.linux-amd64/node_exporter /usr/local/bin/
          sudo useradd -rs /bin/false node_exporter
          sudo systemctl daemon-reload
          sudo systemctl start node_exporter
          sudo systemctl enable node_exporter
        SHELL
      end
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="box.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="totslot.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="box.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="totslot.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
